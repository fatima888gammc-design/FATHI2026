import React, { useState, useEffect, useMemo } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from 'firebase/auth';
import { getFirestore, collection, doc, setDoc, getDoc, addDoc, updateDoc, deleteDoc, onSnapshot, query, orderBy, serverTimestamp } from 'firebase/firestore';
import { Package, Search, Plus, Trash2, Edit2, LogIn, FileText, CheckCircle, AlertTriangle, Database, Save, LogOut, Eye, Cloud } from 'lucide-react';

// Configuration for Cloud Infrastructure (Firebase)
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'media-content-inventory';

export default function App() {
  const [user, setUser] = useState(null);
  const [items, setItems] = useState([]);
  const [loading, setLoading] = useState(true);
  const [isAuthorized, setIsAuthorized] = useState(false);
  const [showLoginModal, setShowLoginModal] = useState(false);
  
  // Auth Form State
  const [loginData, setLoginData] = useState({ username: '', password: '' });
  const [authError, setAuthError] = useState('');

  // Item Form State
  const [formData, setFormData] = useState({
    id: '',
    name: '',
    unit: 'صندوق',
    committeeStock: 0,
    bookStock: 0,
    actualStock: 0,
    notes: ''
  });

  const [searchTerm, setSearchTerm] = useState('');
  const [isEditing, setIsEditing] = useState(false);
  const [duplicateError, setDuplicateError] = useState('');

  const units = ['صندوق', 'رزمة', 'خرطوش', 'لتر', 'عبوة', 'متر طولي', 'أخرى'];

  // Rule 3: Auth First - Critical for Multi-device Cloud Sync
  useEffect(() => {
    const initAuth = async () => {
      try {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
          await signInWithCustomToken(auth, __initial_auth_token);
        } else {
          await signInAnonymously(auth);
        }
      } catch (err) {
        console.error("Cloud Connection Error:", err);
      }
    };
    initAuth();
    const unsubscribe = onAuthStateChanged(auth, (currUser) => {
      setUser(currUser);
    });
    return () => unsubscribe();
  }, []);

  // Rule 1 & 2: Real-time Cloud Firestore Listener
  // This ensures that any change on one device is instantly reflected on all others
  useEffect(() => {
    if (!user) return;

    const itemsRef = collection(db, 'artifacts', appId, 'public', 'data', 'inventory_2025');
    // Using onSnapshot for real-time synchronization across devices
    const unsubscribe = onSnapshot(itemsRef, (snapshot) => {
      const itemList = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      setItems(itemList);
      setLoading(false);
    }, (error) => {
      console.error("Cloud Sync Error:", error);
      setLoading(false);
    });

    return () => unsubscribe();
  }, [user]);

  // Login Logic (AAA / 08082008)
  const handleLogin = (e) => {
    e.preventDefault();
    if (loginData.username === 'AAA' && loginData.password === '08082008') {
      setIsAuthorized(true);
      setAuthError('');
      setShowLoginModal(false);
    } else {
      setAuthError('بيانات الدخول غير صحيحة');
    }
  };

  // CRUD Operations - Direct Cloud Write
  const handleSaveItem = async (e) => {
    e.preventDefault();
    if (!isAuthorized) return;

    const normalizedName = formData.name.trim();
    if (!normalizedName) return;

    // Check for duplicates in the current cloud-synced state
    const isDuplicate = items.some(item => 
      item.name.trim().toLowerCase() === normalizedName.toLowerCase() && 
      item.id !== formData.id
    );

    if (isDuplicate) {
      setDuplicateError(`الصنف "${normalizedName}" موجود مسبقاً!`);
      setTimeout(() => setDuplicateError(''), 4000);
      return;
    }

    const itemData = {
      name: normalizedName,
      unit: formData.unit,
      committeeStock: Number(formData.committeeStock),
      bookStock: Number(formData.bookStock),
      actualStock: Number(formData.actualStock),
      diff: Number(formData.actualStock) - Number(formData.bookStock),
      notes: formData.notes,
      updatedAt: serverTimestamp() // Uses server time for multi-device consistency
    };

    try {
      if (isEditing) {
        const itemRef = doc(db, 'artifacts', appId, 'public', 'data', 'inventory_2025', formData.id);
        await updateDoc(itemRef, itemData);
      } else {
        const itemsRef = collection(db, 'artifacts', appId, 'public', 'data', 'inventory_2025');
        await addDoc(itemsRef, itemData);
      }
      resetForm();
    } catch (err) {
      console.error("Cloud Save Error:", err);
    }
  };

  const handleDelete = async (id) => {
    if (!isAuthorized) return;
    if (window.confirm('هل أنت متأكد من حذف هذا الصنف من السحابة؟')) {
      await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'inventory_2025', id));
    }
  };

  const startEdit = (item) => {
    if (!isAuthorized) return;
    setFormData(item);
    setIsEditing(true);
    window.scrollTo({ top: 0, behavior: 'smooth' });
  };

  const resetForm = () => {
    setFormData({ id: '', name: '', unit: 'صندوق', committeeStock: 0, bookStock: 0, actualStock: 0, notes: '' });
    setIsEditing(false);
    setDuplicateError('');
  };

  // Dashboard Stats (Computed locally from cloud data)
  const stats = useMemo(() => {
    const total = items.length;
    const matched = items.filter(i => Number(i.bookStock) === Number(i.actualStock)).length;
    const mismatched = total - matched;
    const positiveDiff = items.filter(i => (Number(i.actualStock) - Number(i.bookStock)) > 0).length;
    const negativeDiff = items.filter(i => (Number(i.actualStock) - Number(i.bookStock)) < 0).length;
    return { total, matched, mismatched, positiveDiff, negativeDiff };
  }, [items]);

  // Word Export Logic
  const exportToWord = () => {
    const dateStr = new Date().toLocaleDateString('ar-LY');
    const timeStr = new Date().toLocaleTimeString('ar-LY');
    
    let tableRows = items.map(item => `
      <tr>
        <td style="border:1px solid #000; padding:8px; text-align:center;">${item.name}</td>
        <td style="border:1px solid #000; padding:8px; text-align:center;">${item.unit}</td>
        <td style="border:1px solid #000; padding:8px; text-align:center;">${item.committeeStock}</td>
        <td style="border:1px solid #000; padding:8px; text-align:center;">${item.bookStock}</td>
        <td style="border:1px solid #000; padding:8px; text-align:center;">${item.actualStock}</td>
        <td style="border:1px solid #000; padding:8px; text-align:center;">${item.actualStock - item.bookStock}</td>
        <td style="border:1px solid #000; padding:8px; text-align:center;">${item.notes || ''}</td>
      </tr>
    `).join('');

    const content = `
      <html dir="rtl">
      <head><meta charset="UTF-8"></head>
      <body style="font-family: Arial, sans-serif; text-align: center; padding: 20px;">
        <div style="margin-bottom: 20px;">
          <h2>دولة ليبيا</h2>
          <h2>الهيئة العامة لرصد المحتوى الإعلامي</h2>
          <h3>لجنة الجرد السنوية</h3>
          <p>التاريخ: ${dateStr} | الوقت: ${timeStr}</p>
        </div>
        <h2 style="text-decoration: underline;">تقرير الرصيد الافتتاحي السنوي 2025</h2>
        <p>كشف تفصيلي بالأصناف والمطابقات الدفترية والفعليّة</p>
        <table style="width:100%; border-collapse: collapse; margin-top:20px;">
          <thead>
            <tr style="background-color: #f2f2f2;">
              <th style="border:1px solid #000; padding:8px;">اسم الصنف</th>
              <th style="border:1px solid #000; padding:8px;">الوحدة</th>
              <th style="border:1px solid #000; padding:8px;">رصيد اللجنة</th>
              <th style="border:1px solid #000; padding:8px;">الرصيد الدفتري</th>
              <th style="border:1px solid #000; padding:8px;">الرصيد الفعلي</th>
              <th style="border:1px solid #000; padding:8px;">الفروقات</th>
              <th style="border:1px solid #000; padding:8px;">ملاحظات</th>
            </tr>
          </thead>
          <tbody>${tableRows}</tbody>
        </table>
        <div style="margin-top: 50px; display: flex; justify-content: space-around;">
           <div style="display:inline-block; width:30%;">توقيع عضو اللجنة<br>...........................</div>
           <div style="display:inline-block; width:30%;">توقيع رئيس اللجنة<br>...........................</div>
           <div style="display:inline-block; width:30%;">يعتمد: مدير الإدارة<br>...........................</div>
        </div>
        <footer style="margin-top:100px; font-size:12px; border-top: 1px solid #eee; padding-top: 10px;">جميع الحقوق محفوظة : فتحي الترهوني</footer>
      </body>
      </html>
    `;

    const blob = new Blob(['\ufeff', content], { type: 'application/msword' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `تقرير_جرد_الهيئة_2025.doc`;
    link.click();
  };

  const filteredItems = items.filter(item => 
    item.name?.toLowerCase().includes(searchTerm.toLowerCase())
  );

  if (loading) return (
    <div className="min-h-screen bg-[#4169E1] flex flex-col items-center justify-center text-white font-bold">
      <Cloud size={48} className="animate-bounce mb-4 text-yellow-400" />
      <div className="text-2xl animate-pulse">جاري الاتصال بالسحابة...</div>
    </div>
  );

  return (
    <div className="min-h-screen bg-[#4169E1] font-sans text-slate-800" dir="rtl">
      {/* Header */}
      <header className="p-8 text-center bg-[#4169E1] shadow-lg border-b border-blue-400 relative">
        <h1 className="text-4xl md:text-5xl font-bold bg-gradient-to-r from-yellow-300 via-yellow-500 to-yellow-300 bg-clip-text text-transparent drop-shadow-md">
          الهيئة العامة لرصد المحتوى الإعلامي
        </h1>
        <p className="mt-2 text-blue-100 text-lg">نظام الرصيد الافتتاحي السحابي 2025</p>
        
        {/* Auth Badge */}
        <div className="absolute top-4 left-4">
          {isAuthorized ? (
            <div className="flex items-center gap-2 bg-green-500/20 text-green-300 px-4 py-1 rounded-full text-sm border border-green-500/50">
              <span className="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
              مدير النظام المتصل
            </div>
          ) : (
            <div className="flex items-center gap-2 bg-blue-900/40 text-blue-200 px-4 py-1 rounded-full text-sm border border-blue-400/30">
              <Cloud size={14} className="text-yellow-400" />
              الوضع العام السحابي
            </div>
          )}
        </div>
      </header>

      <main className="container mx-auto px-4 py-8">
        
        {/* Dashboard Stats */}
        <div className="grid grid-cols-2 md:grid-cols-5 gap-4 mb-8">
          {[
            { label: 'إجمالي الأصناف', val: stats.total, icon: <Database />, color: 'border-blue-500', text: 'text-blue-600' },
            { label: 'أصناف مطابقة', val: stats.matched, icon: <CheckCircle />, color: 'border-green-500', text: 'text-green-600' },
            { label: 'أصناف غير مطابقة', val: stats.mismatched, icon: <AlertTriangle />, color: 'border-red-500', text: 'text-red-600' },
            { label: 'زيادة في الفعلي', val: stats.positiveDiff, icon: <Plus />, color: 'border-orange-500', text: 'text-orange-600' },
            { label: 'عجز في الفعلي', val: stats.negativeDiff, icon: <Trash2 />, color: 'border-purple-500', text: 'text-purple-600' }
          ].map((s, i) => (
            <div key={i} className={`bg-white p-4 rounded-xl shadow-md border-r-4 ${s.color} hover:scale-105 transition-transform`}>
              <div className={`flex items-center gap-2 ${s.text} mb-1`}>
                {React.cloneElement(s.icon, { size: 18 })}
                <span className="text-xs font-bold">{s.label}</span>
              </div>
              <p className="text-2xl font-bold">{s.val}</p>
            </div>
          ))}
        </div>

        {/* Edit Form (Only for Authorized Users) */}
        {isAuthorized && (
          <section className="bg-white p-6 rounded-2xl shadow-xl mb-8 border-t-4 border-blue-600 animate-in slide-in-from-top duration-500">
            <div className="flex items-center justify-between mb-4 border-b pb-2">
              <div className="flex items-center gap-2 text-blue-800 font-bold">
                <Package size={20} />
                {isEditing ? 'تحديث بيانات الصنف' : 'إضافة صنف سحابي جديد'}
              </div>
              {duplicateError && (
                <div className="text-red-600 text-sm font-bold bg-red-50 px-4 py-1 rounded-lg animate-pulse border border-red-200">
                  {duplicateError}
                </div>
              )}
            </div>
            <form onSubmit={handleSaveItem} className="grid grid-cols-1 md:grid-cols-4 lg:grid-cols-7 gap-4 items-end">
              <div className="md:col-span-1 lg:col-span-2">
                <label className="block text-xs font-bold mb-1">اسم الصنف</label>
                <input required type="text" placeholder="اسم الصنف..." className="w-full p-2 border rounded bg-slate-50 outline-none" value={formData.name} onChange={(e) => {setFormData({...formData, name: e.target.value}); setDuplicateError('');}} />
              </div>
              <div>
                <label className="block text-xs font-bold mb-1">الوحدة</label>
                <select className="w-full p-2 border rounded bg-slate-50 outline-none" value={formData.unit} onChange={(e) => setFormData({...formData, unit: e.target.value})}>
                  {units.map(u => <option key={u} value={u}>{u}</option>)}
                </select>
              </div>
              <div>
                <label className="block text-xs font-bold mb-1 text-blue-600">رصيد اللجنة</label>
                <input type="number" className="w-full p-2 border rounded bg-blue-50 outline-none" value={formData.committeeStock} onChange={(e) => setFormData({...formData, committeeStock: e.target.value})} />
              </div>
              <div>
                <label className="block text-xs font-bold mb-1 text-slate-600">الرصيد الدفتري</label>
                <input type="number" className="w-full p-2 border rounded bg-slate-50 outline-none" value={formData.bookStock} onChange={(e) => setFormData({...formData, bookStock: e.target.value})} />
              </div>
              <div>
                <label className="block text-xs font-bold mb-1 text-green-600">الرصيد الفعلي</label>
                <input type="number" className="w-full p-2 border rounded bg-green-50 outline-none" value={formData.actualStock} onChange={(e) => setFormData({...formData, actualStock: e.target.value})} />
              </div>
              <div className="lg:flex gap-2">
                <button type="submit" className="w-full bg-blue-600 text-white p-2 rounded hover:bg-blue-800 transition flex items-center justify-center gap-1 font-bold shadow-md">
                  <Save size={18} /> {isEditing ? 'تحديث' : 'حفظ'}
                </button>
                {isEditing && <button type="button" onClick={resetForm} className="mt-2 lg:mt-0 w-full bg-gray-400 text-white p-2 rounded hover:bg-gray-500 font-bold">إلغاء</button>}
              </div>
            </form>
          </section>
        )}

        {/* Search and Global Actions */}
        <div className="flex flex-col md:flex-row justify-between items-center gap-4 mb-6">
          <div className="relative w-full md:w-96">
            <Search className="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400" size={20} />
            <input type="text" placeholder="بحث سريع في القاعدة السحابية..." className="w-full pr-10 p-3 rounded-full border-none shadow-lg outline-none focus:ring-2 focus:ring-yellow-400" value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} />
          </div>
          
          <div className="flex gap-2 w-full md:w-auto">
            <button onClick={exportToWord} className="flex-1 md:flex-none flex items-center justify-center gap-2 bg-yellow-500 text-blue-900 font-bold px-6 py-3 rounded-full hover:bg-yellow-400 transition shadow-lg border-2 border-yellow-200">
              <FileText size={20} /> تصدير التقرير النهائي
            </button>
            
            {!isAuthorized ? (
              <button onClick={() => setShowLoginModal(true)} className="flex items-center justify-center gap-2 bg-blue-900 text-white font-bold px-6 py-3 rounded-full hover:bg-slate-900 transition shadow-lg">
                <LogIn size={20} /> دخول المشرف
              </button>
            ) : (
              <button onClick={() => { setIsAuthorized(false); resetForm(); }} className="flex items-center justify-center bg-red-600 text-white p-3 rounded-full hover:bg-red-700 transition shadow-lg" title="تسجيل الخروج">
                <LogOut size={20} />
              </button>
            )}
          </div>
        </div>

        {/* Main Table */}
        <div className="bg-white rounded-2xl shadow-2xl overflow-hidden border border-blue-200">
          <div className="overflow-x-auto">
            <table className="w-full text-right border-collapse">
              <thead>
                <tr className="bg-slate-50 border-b-2 border-slate-200">
                  <th className="p-4 font-bold text-slate-500 text-center w-12">#</th>
                  <th className="p-4 font-bold text-slate-700">اسم الصنف</th>
                  <th className="p-4 font-bold text-slate-700">الوحدة</th>
                  <th className="p-4 font-bold text-blue-700 text-center">رصيد اللجنة</th>
                  <th className="p-4 font-bold text-slate-700 text-center">الرصيد الدفتري</th>
                  <th className="p-4 font-bold text-green-700 text-center">الرصيد الفعلي</th>
                  <th className="p-4 font-bold text-slate-700 text-center">الفروقات</th>
                  {isAuthorized && <th className="p-4 font-bold text-slate-700 text-center">إجراءات</th>}
                </tr>
              </thead>
              <tbody>
                {filteredItems.length === 0 ? (
                  <tr>
                    <td colSpan={isAuthorized ? 8 : 7} className="p-16 text-center text-gray-400 italic">لا توجد بيانات متاحة حالياً</td>
                  </tr>
                ) : (
                  filteredItems.map((item, index) => {
                    const diff = (Number(item.actualStock) || 0) - (Number(item.bookStock) || 0);
                    return (
                      <tr key={item.id} className="border-b hover:bg-blue-50/50 transition border-slate-100 group">
                        <td className="p-4 text-gray-400 text-xs text-center">{index + 1}</td>
                        <td className="p-4 font-bold text-slate-800">{item.name}</td>
                        <td className="p-4"><span className="px-3 py-1 bg-slate-100 rounded-full text-xs border border-slate-200">{item.unit}</span></td>
                        <td className="p-4 text-blue-700 font-bold text-center bg-blue-50/20">{item.committeeStock}</td>
                        <td className="p-4 text-center font-medium">{item.bookStock}</td>
                        <td className="p-4 text-green-700 font-bold text-center bg-green-50/20">{item.actualStock}</td>
                        <td className="p-4 text-center">
                          <span className={`font-bold px-3 py-1 rounded-full text-sm ${diff > 0 ? 'text-green-700 bg-green-100' : diff < 0 ? 'text-red-700 bg-red-100' : 'text-gray-400 bg-gray-100'}`}>
                            {diff > 0 ? `+${diff}` : diff}
                          </span>
                        </td>
                        {isAuthorized && (
                          <td className="p-4">
                            <div className="flex justify-center gap-1 opacity-20 group-hover:opacity-100 transition-opacity">
                              <button onClick={() => startEdit(item)} className="p-2 text-blue-600 hover:bg-blue-100 rounded-full transition"><Edit2 size={16} /></button>
                              <button onClick={() => handleDelete(item.id)} className="p-2 text-red-600 hover:bg-red-100 rounded-full transition"><Trash2 size={16} /></button>
                            </div>
                          </td>
                        )}
                      </tr>
                    );
                  })
                )}
              </tbody>
            </table>
          </div>
        </div>

        {/* Login Modal */}
        {showLoginModal && (
          <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4">
            <div className="bg-white w-full max-w-md rounded-2xl shadow-2xl overflow-hidden animate-in zoom-in-95 duration-200">
              <div className="p-6 bg-blue-900 text-white flex justify-between items-center">
                <div className="flex items-center gap-2">
                  <LogIn size={20} className="text-yellow-400" />
                  <h2 className="text-xl font-bold">تسجيل دخول المشرف</h2>
                </div>
                <button onClick={() => setShowLoginModal(false)} className="text-white/60 hover:text-white">&times;</button>
              </div>
              <div className="p-8">
                <form onSubmit={handleLogin} className="space-y-4">
                  <div>
                    <label className="block text-sm font-bold mb-1 text-slate-700">اسم المستخدم</label>
                    <input autoFocus type="text" className="w-full p-3 border rounded-lg bg-gray-50 outline-none border-slate-200" value={loginData.username} onChange={(e) => setLoginData({...loginData, username: e.target.value})} />
                  </div>
                  <div>
                    <label className="block text-sm font-bold mb-1 text-slate-700">كلمة السر</label>
                    <input type="password" className="w-full p-3 border rounded-lg bg-gray-50 outline-none border-slate-200" value={loginData.password} onChange={(e) => setLoginData({...loginData, password: e.target.value})} />
                  </div>
                  {authError && <p className="text-red-500 text-sm font-bold text-center">{authError}</p>}
                  <button type="submit" className="w-full bg-blue-900 text-white p-3 rounded-lg font-bold hover:bg-black transition shadow-lg mt-4">تأكيد الدخول</button>
                </form>
              </div>
            </div>
          </div>
        )}

        <footer className="mt-12 text-center text-blue-100 opacity-80 pb-8 border-t border-blue-400/30 pt-8">
          <div className="flex items-center justify-center gap-2 mb-2">
            <Cloud size={14} />
            <span className="text-xs">نظام سحابي مشفر وآمن</span>
          </div>
          <p className="text-sm font-bold">الهيئة العامة لرصد المحتوى الإعلامي - ليبيا</p>
          <p className="text-xs mt-1">جميع الحقوق محفوظة : فتحي الترهوني &copy; 2026</p>
        </footer>
      </main>
    </div>
  );

}
